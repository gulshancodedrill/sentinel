<?php

/**
 * @file
 * Sentinel Portal Queue module.
 */

use Drupal\Component\Utility\Html;
use Drupal\Core\File\FileSystemInterface;
use Drupal\Core\Mail\MailFormatHelper;
use Symfony\Component\Mailer\Mailer;
use Symfony\Component\Mailer\MailerInterface;
use Symfony\Component\Mailer\Transport;
use Symfony\Component\Mailer\Transport\Dsn;
use Symfony\Component\Mime\Address;
use Symfony\Component\Mime\Email;

/**
 * Implements hook_cron_queue_info().
 */
function sentinel_portal_queue_cron_queue_info() {
  $queues['sentinel_queue'] = [
    'worker callback' => 'sentinel_portal_queue_run_action',
    'time' => 60,
    'skip on cron' => FALSE,
  ];

  \Drupal::logger('sentinel_portal_queue')->info('Cron queue info registered for sentinel_queue.');
  return $queues;
}

/**
 * Queue processing callback from hook_cron_queue_info().
 *
 * @param object $queue_item_data
 *   The queue item data.
 */
function sentinel_portal_queue_run_action($queue_item_data) {
  $queue = \Drupal::queue('sentinel_queue');

  $action = $queue_item_data->action ?? 'undefined';
  $pid = $queue_item_data->pid ?? 'undefined';

  \Drupal::logger('sentinel_portal_queue')->info('Processing sentinel_queue item with action @action for PID @pid.', [
    '@action' => $action,
    '@pid' => $pid,
  ]);

  switch ($queue_item_data->action) {
    case 'sendreport':
      // Send the report to the end user.
      _sentinel_portal_queue_process_sendresults($queue, $queue_item_data);
      break;

    case 'invalid_pack':
      // Invalid pack found.
      _sentinel_portal_queue_process_invalid_pack($queue, $queue_item_data);
      break;

    case 'generate_results':
      // Force generate the results. Follows onto sendreport.
      _sentinel_portal_queue_generate_results($queue, $queue_item_data);
      break;

    case 'invoke_send_results_hook':
      _sentinel_portal_queue_invoke_send_results_hook($queue, $queue_item_data);
      break;
  }
}

/**
 * Quick function used to create a queue item.
 *
 * @param object $sample
 *   The sample object.
 * @param string $action
 *   The current action being performed.
 * @param bool|int $expire
 *   An optional expiry time.
 */
function sentinel_portal_queue_create_item($sample, $action, $expire = FALSE) {
  $queue = \Drupal::queue('sentinel_queue');
  $payload = new \stdClass();

  $payload->pid = NULL;
  if ($sample instanceof \Drupal\Core\Entity\EntityInterface) {
    $identifier = $sample->id();
    if (!$identifier && $sample->hasField('pid')) {
      $identifier = $sample->get('pid')->value;
    }
    $payload->pid = $identifier;
  }
  elseif (is_object($sample) && isset($sample->pid)) {
    $payload->pid = is_array($sample->pid) && isset($sample->pid['value']) ? $sample->pid['value'] : $sample->pid;
  }
  elseif (is_array($sample) && isset($sample['pid'])) {
    $payload->pid = $sample['pid'];
  }

  if ($payload->pid !== NULL) {
    $payload->pid = (string) $payload->pid;
  }

  $payload->action = $action;
  $payload->created = \Drupal::time()->getCurrentTime();
  if ($expire !== FALSE) {
    $payload->expire = $expire;
  }

  \Drupal::logger('sentinel_portal_queue')->info('Creating queue item for action @action, PID @pid, expire @expire.', [
    '@action' => $payload->action,
    '@pid' => $payload->pid ?? 'NULL',
    '@expire' => isset($payload->expire) ? $payload->expire : 'none',
  ]);

  $item_id = $queue->createItem($payload);

  if ($item_id) {
    \Drupal::logger('sentinel_portal_queue')->info('Queue item @item_id created for action @action, PID @pid.', [
      '@item_id' => $item_id,
      '@action' => $payload->action,
      '@pid' => $payload->pid ?? 'NULL',
    ]);

    $connection = \Drupal::database();
    $fields = [
      'name' => 'sentinel_queue',
      'data' => serialize($payload),
      'pid' => $payload->pid,
      'action' => $action,
      'failed' => 0,
      'expire' => $payload->expire ?? 0,
      'created' => $payload->created,
    ];

    $exists = (bool) $connection->select('sentinel_portal_queue', 'q')
      ->fields('q', ['item_id'])
      ->condition('item_id', $item_id)
      ->execute()
      ->fetchField();

    if ($exists) {
      $connection->update('sentinel_portal_queue')
        ->fields($fields)
        ->condition('item_id', $item_id)
        ->execute();
    }
    else {
      $fields['item_id'] = $item_id;
      $connection->insert('sentinel_portal_queue')
        ->fields($fields)
        ->execute();
    }
  }
  else {
    \Drupal::logger('sentinel_portal_queue')->warning('Failed to create queue item for action @action, PID @pid.', [
      '@action' => $payload->action,
      '@pid' => $payload->pid ?? 'NULL',
    ]);
  }
}

/**
 * Remove a queue record from the tracking table.
 */
function sentinel_portal_queue_delete_record($item_id) {
  \Drupal::database()->delete('sentinel_portal_queue')
    ->condition('item_id', $item_id)
    ->execute();
}

/**
 * Remove a queue record using payload metadata when item ID is unavailable.
 *
 * @param object $payload
 *   The queue payload.
 */
function sentinel_portal_queue_delete_record_by_payload($payload) {
  if (!isset($payload->pid) || !isset($payload->action) || !isset($payload->created)) {
    \Drupal::logger('sentinel_portal_queue')->warning('Unable to delete tracking record: insufficient payload data.');
    return;
  }

  $connection = \Drupal::database();
  $item_id = $connection->select('sentinel_portal_queue', 'q')
    ->fields('q', ['item_id'])
    ->condition('name', 'sentinel_queue')
    ->condition('pid', $payload->pid)
    ->condition('action', $payload->action)
    ->condition('created', $payload->created)
    ->orderBy('item_id', 'DESC')
    ->range(0, 1)
    ->execute()
    ->fetchField();

  if ($item_id) {
    sentinel_portal_queue_delete_record($item_id);
  }
  else {
    \Drupal::logger('sentinel_portal_queue')->warning('Unable to find tracking record to delete for PID @pid and action @action.', [
      '@pid' => $payload->pid,
      '@action' => $payload->action,
    ]);
  }
}

/**
 * Increment failed count for a queue item.
 */
function sentinel_portal_queue_increment_failed($item_id) {
  \Drupal::database()->update('sentinel_portal_queue')
    ->expression('failed', 'failed + 1')
    ->condition('item_id', $item_id)
    ->execute();
}

/**
 * Increment failed count for a queue payload when item ID is unavailable.
 *
 * @param object $payload
 *   The queue payload.
 */
function sentinel_portal_queue_increment_failed_by_payload($payload) {
  if (!isset($payload->pid) || !isset($payload->action) || !isset($payload->created)) {
    \Drupal::logger('sentinel_portal_queue')->warning('Unable to increment failed count: insufficient payload data.');
    return;
  }

  $connection = \Drupal::database();
  $item_id = $connection->select('sentinel_portal_queue', 'q')
    ->fields('q', ['item_id'])
    ->condition('name', 'sentinel_queue')
    ->condition('pid', $payload->pid)
    ->condition('action', $payload->action)
    ->condition('created', $payload->created)
    ->orderBy('item_id', 'DESC')
    ->range(0, 1)
    ->execute()
    ->fetchField();

  if ($item_id) {
    sentinel_portal_queue_increment_failed($item_id);
  }
  else {
    \Drupal::logger('sentinel_portal_queue')->warning('Unable to find tracking record to increment for PID @pid and action @action.', [
      '@pid' => $payload->pid,
      '@action' => $payload->action,
    ]);
  }
}

/**
 * Implements hook_mail().
 */
function sentinel_portal_queue_mail($key, &$message, $params) {
  switch ($key) {
    case 'sentinel_portal_service_sample':
      if (isset($params['subject'])) {
        $message['subject'] = $params['subject'];
      }
      else {
        $message['subject'] = t('Pack Reference Number: @pack_reference_number', ['@pack_reference_number' => $params['pack_reference_number']]);
      }

      $message['body'][] = '';
      $message['body'][] = t('@message', ['@message' => $params['message']]);
      $message['body'][] = '';
      $message['body'][] = t('@pack_details', ['@pack_details' => $params['pack_details']]);
      $message['body'][] = '';
      $message['body'][] = t('Thanks,');
      $message['body'][] = t('Sentinel');
      break;
  }
}

/**
 * Format pack reference numbers function for sentinel_portal_submit_form.
 *
 * @param string $packref
 *   The pack reference number.
 *
 * @return string|bool
 *   False if problem with pack reference.
 */
function sentinel_portal_service_format_packref($packref) {
  $pattern = '/^([0-9]{3})[:\s-]?([0-9]{3,10}[a-zA-Z]?)$/';
  $matches = [];
  $result = preg_match_all($pattern, trim($packref), $matches);

  if (isset($matches[1][0]) || isset($matches[2][0])) {
    // Glue the two packref parts back together
    return $matches[1][0] . ':' . $matches[2][0];
  }
  else {
    return FALSE;
  }
}

/**
 * Retrieve sample by PID.
 *
 * @param int $pid
 *   The sample PID.
 *
 * @return object|bool
 *   The sample entity or FALSE.
 */
function _sentinel_portal_service_retrieve_by_pid($pid) {
  $entity_type_manager = \Drupal::entityTypeManager();
  $storage = $entity_type_manager->getStorage('sentinel_sample');
  
  $query = $storage->getQuery()
    ->condition('pid', $pid, '=')
    ->range(0, 1)
    ->accessCheck(FALSE);

  $result = $query->execute();

  if (!empty($result)) {
    $sample_ids = array_values($result);
    $sample = $storage->load(reset($sample_ids));
    return $sample;
  }
  else {
    return FALSE;
  }
}

/**
 * Function to validate date formats.
 *
 * @param array $data
 *   The data array containing date fields.
 *
 * @return bool|string
 *   True if everything worked. The date field if there was a problem.
 */
function sentinel_portal_service_validate_dates(&$data) {
  $date_fields = [
    'sample_date',
    'date_sent',
  ];

  foreach ($date_fields as $date_field) {
    if (isset($data[$date_field])) {
      // Attempt to extract the date.
      $obj_date = \DateTime::createFromFormat('Y-m-d\TH:i', $data[$date_field]);
      if ($obj_date === FALSE) {
        // Failed the first parse attempt, so we try the non-hyphenated version.
        $obj_date = \DateTime::createFromFormat('Ymd\TH:i', $data[$date_field]);
        if ($obj_date === FALSE) {
          // Date is clearly invalid.
          return $date_field;
        }
        else {
          // If the date parsed correctly then we save it back to the $data array.
          $data[$date_field] = $obj_date->format('Y-m-d\TH:i');
        }
      }
    }
  }

  return TRUE;
}

/**
 * Send the sample report to the user.
 *
 * @param object $queue
 *   The queue object.
 * @param object $item
 *   The queue item object.
 *
 * @return bool
 *   True if everything worked, otherwise false.
 */
function _sentinel_portal_queue_process_sendresults($queue, $item) {
  $entity_type_manager = \Drupal::entityTypeManager();
  $storage = $entity_type_manager->getStorage('sentinel_sample');
  $sample_entity = $storage->load($item->pid);

  \Drupal::logger('sentinel_portal_queue')->info('Sendresults processing started for PID @pid.', [
    '@pid' => $item->pid ?? 'unknown',
  ]);

  if (is_object($sample_entity)) {
    // Sent report email!
    $result = _sentinel_portal_queue_process_email($sample_entity, 'report');

    if ($result === FALSE) {
      // Something failed in the send email function.
      \Drupal::logger('sentinel_portal_queue')->info('Failed to send entity mail! @id', ['@id' => $item->pid]);
      if (isset($item->item_id)) {
      sentinel_portal_queue_increment_failed($item->item_id);
      }
      else {
        sentinel_portal_queue_increment_failed_by_payload($item);
      }
    }
    else {
      // Everything went well in the send email function.
      \Drupal::logger('sentinel_portal_queue')->info('Sample entity mail sent! @id', ['@id' => $item->pid]);

      // See if anything else wants to send the sample results out.
      \Drupal::moduleHandler()->invokeAll('sentinel_sendresults', [$sample_entity]);

      // As we have sent the email we can delete the item from the queue.
      if (isset($item->item_id)) {
      $queue->deleteItem($item);
      sentinel_portal_queue_delete_record($item->item_id);
      }
      else {
        sentinel_portal_queue_delete_record_by_payload($item);
      }
    }
  }
  else {
    \Drupal::logger('sentinel_portal_queue')->error('Sample entity could not be loaded @id', ['@id' => $item->pid]);
  }

  \Drupal::logger('sentinel_portal_queue')->info('Sendresults processing completed for PID @pid.', [
    '@pid' => $item->pid ?? 'unknown',
  ]);
}

/**
 * Invokes the send results hook and allows the queue system to process many items.
 *
 * @param object $queue
 *   The queue.
 * @param object $item
 *   The item in the queue.
 */
function _sentinel_portal_queue_invoke_send_results_hook($queue, $item) {
  $entity_type_manager = \Drupal::entityTypeManager();
  $storage = $entity_type_manager->getStorage('sentinel_sample');
  $sample_entity = $storage->load($item->pid);

  \Drupal::logger('sentinel_portal_queue')->info('Invoke send results hook for PID @pid.', [
    '@pid' => $item->pid ?? 'unknown',
  ]);

  if (is_object($sample_entity)) {
    // See if anything else wants to send the sample results out.
    \Drupal::moduleHandler()->invokeAll('sentinel_sendresults', [$sample_entity]);

    // As we have sent the email we can delete the item from the queue.
    if (isset($item->item_id)) {
    $queue->deleteItem($item);
    sentinel_portal_queue_delete_record($item->item_id);
    }
    else {
      sentinel_portal_queue_delete_record_by_payload($item);
    }
  }
  else {
    \Drupal::logger('sentinel_portal_queue')->error('Sample entity could not be loaded @id', ['@id' => $item->pid]);
  }
}

/**
 * Process an invalid pack.
 *
 * @param object $queue
 *   The queue object.
 * @param object $item
 *   The queue item object.
 *
 * @return bool
 *   True if everything worked, otherwise false.
 */
function _sentinel_portal_queue_process_invalid_pack($queue, $item) {
  $config = \Drupal::config('sentinel_portal.settings');
  $error_email = $config->get('new_pack_email') ?? 'admin@example.com';

  \Drupal::logger('sentinel_portal_queue')->info('Invalid pack processing started for PID @pid.', [
    '@pid' => $item->pid ?? 'unknown',
  ]);

  // Load sample.
  $sentinel_sample = _sentinel_portal_service_retrieve_by_pid($item->pid);
  
  if (!$sentinel_sample) {
    \Drupal::logger('sentinel_portal_queue')->error('Sample not found for PID @pid', ['@pid' => $item->pid]);
    if (isset($item->item_id)) {
    $queue->deleteItem($item);
    sentinel_portal_queue_delete_record($item->item_id);
    }
    else {
      sentinel_portal_queue_delete_record_by_payload($item);
    }
    return FALSE;
  }

  $pack_type = method_exists($sentinel_sample, 'getSampleType') ? 
    str_replace('_', ' ', $sentinel_sample->getSampleType()) : 
    'Unknown';

  // Get validation errors for this sample.
  $errors = method_exists($sentinel_sample, 'validateSample') ? 
    $sentinel_sample->validateSample() : 
    [];

  if (count($errors) == 0) {
    // The validation errors were fixed since this queue item was created.
    // Delete the items from the queue and return.
    if (isset($item->item_id)) {
    $queue->deleteItem($item);
    sentinel_portal_queue_delete_record($item->item_id);
    }
    else {
      sentinel_portal_queue_delete_record_by_payload($item);
    }
    return TRUE;
  }

  // Send email detailing errors.
  $message = '';
  $pack_reference = method_exists($sentinel_sample, 'get') ? 
    $sentinel_sample->get('pack_reference_number')->value : 
    'Unknown';

  $message .= 'Invalid ' . $pack_type . ' pack information found for pack ' . $pack_reference . ', please review error below.' . PHP_EOL;
  $message .= PHP_EOL;

  // Create pack details.
  $pack_details = '';
  foreach ($errors as $field => $error) {
    $pack_details .= $field . ' ' . $error . PHP_EOL;
  }

  $message .= PHP_EOL;

  $params = [
    'subject' => t('@pack_type Sample @pack_reference_number', [
      '@pack_type' => $pack_type, 
      '@pack_reference_number' => $pack_reference
    ]),
    'message' => $message,
    'pack_details' => $pack_details,
    'pack_reference_number' => $pack_reference,
  ];

  $mail_manager = \Drupal::service('plugin.manager.mail');
  $result = $mail_manager->mail('sentinel_portal_queue', 'sentinel_portal_service_sample', $error_email, 'en', $params);

  // Delete the item here.
  if (isset($item->item_id)) {
  $queue->deleteItem($item);
  sentinel_portal_queue_delete_record($item->item_id);
  }
  else {
    sentinel_portal_queue_delete_record_by_payload($item);
  }

  return $result['result'] == TRUE;
}

/**
 * Queue processor that generates results for a sample.
 *
 * @param object $queue
 *   The queue object.
 * @param object $item
 *   The queue item object.
 *
 * @return bool
 *   True if everything worked, otherwise false.
 */
function _sentinel_portal_queue_generate_results($queue, $item) {
  // Load the sample.
  $sentinel_sample = _sentinel_portal_service_retrieve_by_pid($item->pid);

  \Drupal::logger('sentinel_portal_queue')->info('Generate results processing started for PID @pid.', [
    '@pid' => $item->pid ?? 'unknown',
  ]);

  if (!$sentinel_sample) {
    \Drupal::logger('sentinel_portal_queue')->error('Sample not found for PID @pid', ['@pid' => $item->pid]);
    if (isset($item->item_id)) {
    $queue->deleteItem($item);
    sentinel_portal_queue_delete_record($item->item_id);
    }
    else {
      sentinel_portal_queue_delete_record_by_payload($item);
    }
    return FALSE;
  }

  $is_pass = method_exists($sentinel_sample, 'isPass') ? $sentinel_sample->isPass() : FALSE;
  $is_fail = method_exists($sentinel_sample, 'isFail') ? $sentinel_sample->isFail() : FALSE;

  if ($is_pass == FALSE && $is_fail == FALSE) {
    // Sample has already been reported on. Delete it from the queue and return.
    if (isset($item->item_id)) {
    $queue->deleteItem($item);
    sentinel_portal_queue_delete_record($item->item_id);
    }
    else {
      sentinel_portal_queue_delete_record_by_payload($item);
    }
    return TRUE;
  }

  // Generate the results for the sample.
  if (function_exists('sentinel_systemcheck_certificate_populate_results')) {
    sentinel_systemcheck_certificate_populate_results(new \stdClass(), $sentinel_sample, new \stdClass());
  }
  
  // Saving the entity is important. Create a new revision on each update.
  $sentinel_sample->setNewRevision(TRUE);
  $sentinel_sample->save();

  // Now send the client the report.
  sentinel_portal_queue_create_item($sentinel_sample, 'sendreport');

  // Delete the item from the queue.
  if (isset($item->item_id)) {
  $queue->deleteItem($item);
  sentinel_portal_queue_delete_record($item->item_id);
  }
  else {
    sentinel_portal_queue_delete_record_by_payload($item);
  }
  return TRUE;
}

/**
 * Method that allows us to send emails with the certificate attached.
 *
 * @param object $sample_entity
 *   The sample entity object.
 * @param string $type
 *   The type of email to send.
 *
 * @return bool
 *   True if everything worked out.
 */
function _sentinel_portal_queue_process_email($sample_entity, $type) {
  if ($type !== 'report' || !is_object($sample_entity)) {
    return FALSE;
  }

  $pdf_info = sentinel_portal_queue_get_pdf_info($sample_entity);
  if (!$pdf_info) {
    \Drupal::logger('sentinel_portal_queue')->error('Unable to generate certificate PDF for sample @id', ['@id' => method_exists($sample_entity, 'id') ? $sample_entity->id() : 'unknown']);
    return FALSE;
  }

  $email_payload = sentinel_portal_queue_build_email_payload($sample_entity);
  if (!$email_payload) {
    \Drupal::logger('sentinel_portal_queue')->error('Unable to build email payload for sample @id', ['@id' => method_exists($sample_entity, 'id') ? $sample_entity->id() : 'unknown']);
    return FALSE;
  }

  $sent = sentinel_portal_queue_send_email_with_attachment($email_payload, $pdf_info);

  if ($sent && function_exists('sentinel_systemcheck_custom_rule_events_invoke_sample_result_calculated')) {
    sentinel_systemcheck_custom_rule_events_invoke_sample_result_calculated(
      implode(',', $email_payload['recipients']),
      $pdf_info['uri'],
      $email_payload['subject'],
      $email_payload['message_html'],
      $email_payload['message_plain']
    );
  }

  return $sent;
}

/**
 * Build the PDF attachment metadata for a sample.
 *
 * When called from queue processing, this will delete any existing PDF
 * and generate a new one to ensure the latest data is included.
 */
function sentinel_portal_queue_get_pdf_info($sample_entity) {
  if (!method_exists($sample_entity, 'GetPDF')) {
    return FALSE;
  }

  // Delete existing PDF file if it exists, so we can generate a fresh one.
  // This ensures the PDF contains the latest sample data when sent via queue.
  if (method_exists($sample_entity, 'deleteExistingPdf')) {
    $sample_entity->deleteExistingPdf();
    \Drupal::logger('sentinel_portal_queue')->info('Deleted existing PDF for sample @id before generating new one for queue processing.', [
      '@id' => method_exists($sample_entity, 'id') ? $sample_entity->id() : 'unknown',
    ]);
  }

  // Generate a new PDF (GetPDF will call SavePdf if no file exists).
  $uri = $sample_entity->GetPDF();
  if (empty($uri)) {
    return FALSE;
  }

  $file_system = \Drupal::service('file_system');
  $path = $file_system->realpath($uri);
  if (!$path || !file_exists($path)) {
    return FALSE;
  }

  return [
    'uri' => $uri,
    'path' => $path,
    'filename' => basename($path),
  ];
}

/**
 * Retrieve a scalar value from the sample entity.
 */
function sentinel_portal_queue_get_sample_value($sample_entity, string $field) {
  if (method_exists($sample_entity, 'hasField') && $sample_entity->hasField($field)) {
    $field_item = $sample_entity->get($field);
    if (!$field_item->isEmpty()) {
      $value = $field_item->value;
      if ($value !== NULL && $value !== '') {
        return $value;
      }
    }
  }

  if (isset($sample_entity->$field) && $sample_entity->$field !== '') {
    $value = $sample_entity->$field;
    if ($value instanceof \Drupal\Core\Field\FieldItemListInterface) {
      $item = $value->first();
      if ($item && $item->getValue()) {
        $scalar = reset($item->getValue());
        if ($scalar !== NULL && $scalar !== '') {
          return $scalar;
        }
      }
      return NULL;
    }

    if (is_scalar($value)) {
      return $value;
    }
  }

  return NULL;
}

/**
 * Build the subject, body and recipients for the send results email.
 */
function sentinel_portal_queue_build_email_payload($sample_entity) {
  // Check if UCR is pending first.
  $ucr = sentinel_portal_queue_get_sample_value($sample_entity, 'ucr');
  $ucr_pending = ($ucr === 'pending' || strtolower($ucr) === 'pending');
  
  // If UCR is pending, send email to admin instead of installer/company.
  if ($ucr_pending) {
    $admin_email = \Drupal::config('sentinel_portal.settings')->get('new_pack_email')
      ?: \Drupal::config('system.site')->get('mail')
      ?: 'admin@sentinelprotects.com';
    $recipients = [$admin_email];
  }
  else {
    $installer_email = sentinel_portal_queue_get_sample_value($sample_entity, 'installer_email');
    $company_email = sentinel_portal_queue_get_sample_value($sample_entity, 'company_email');

    if (empty($installer_email) && empty($company_email)) {
      return FALSE;
    }

    $recipients = sentinel_portal_queue_filter_recipients([
      $installer_email,
      $company_email,
    ]);
    if (empty($recipients)) {
      return FALSE;
    }
  }

  $pack_reference = sentinel_portal_queue_get_sample_value($sample_entity, 'pack_reference_number') ?? 'Unknown';
  $system_address = 'Unknown';
  if (method_exists($sample_entity, 'getSystemAddress')) {
    $system_address = $sample_entity->getSystemAddress();
  }
  elseif ($value = sentinel_portal_queue_get_sample_value($sample_entity, 'system_location')) {
    $system_address = $value;
  }

  $country = method_exists($sample_entity, 'getSampleCountry') ? strtolower($sample_entity->getSampleCountry()) : 'gb';
  $sample_type = method_exists($sample_entity, 'getSampleType') ? $sample_entity->getSampleType() : 'standard';
  $is_pass = method_exists($sample_entity, 'isPass') ? $sample_entity->isPass() : ((int) sentinel_portal_queue_get_sample_value($sample_entity, 'pass_fail') === 1);
  $pass_label = $is_pass ? 'PASS' : 'FAIL';

  if ($sample_type === 'vaillant') {
    $subject = sprintf('Sentinel Vaillant System Check Report: %s - %s - %s', strip_tags($pack_reference), $pass_label, strip_tags($system_address));
  }
  else {
    $subject = sprintf('Sentinel System Check Report: %s - %s - %s', strip_tags($pack_reference), $pass_label, strip_tags($system_address));
  }

  $message_html = sentinel_portal_queue_build_message_html($sample_entity, $country, $is_pass, $sample_type, $ucr_pending);
  $message_plain = MailFormatHelper::htmlToText($message_html);

  return [
    'recipients' => $recipients,
          'subject' => $subject,
          'message_html' => $message_html,
          'message_plain' => $message_plain,
  ];
}

/**
 * Split, validate, and filter recipient emails using the stoplist.
 *
 * @param array $raw_values
 *   Raw email strings (may contain multiple addresses).
 *
 * @return array
 *   Valid, non-blocked email addresses (unique, ordered).
 */
function sentinel_portal_queue_filter_recipients(array $raw_values) {
  $emails = [];
  foreach ($raw_values as $raw) {
    if (empty($raw)) {
      continue;
    }
    $parts = preg_split('/[;,]+/', (string) $raw);
    foreach ($parts as $part) {
      $address = trim($part);
      if ($address === '') {
        continue;
      }
      if (\Drupal::service('email.validator')->isValid($address)) {
        $emails[] = $address;
      }
    }
  }

  if (empty($emails)) {
    return [];
  }

  $stop_list = \Drupal::config('sentinel_portal.settings')->get('stop_emails') ?: '';
  $blocked = [];
  foreach (preg_split('/\r\n|\r|\n/', $stop_list) as $line) {
    $line = trim($line);
    if ($line !== '') {
      $blocked[] = strtolower($line);
    }
  }

  $filtered = [];
  foreach ($emails as $address) {
    $domain = strtolower(substr($address, strrpos($address, '@') + 1));
    if (!in_array($domain, $blocked, TRUE)) {
      $filtered[] = $address;
    }
  }

  return array_values(array_unique($filtered));
}

/**
 * Build the HTML body for the send results email.
 *
 * @param object $sample_entity
 *   The sample entity.
 * @param string $country
 *   The country code.
 * @param bool $is_pass
 *   Whether the sample passed.
 * @param string $sample_type
 *   The sample type.
 * @param bool $ucr_pending
 *   Whether the UCR is pending.
 *
 * @return string
 *   The HTML message.
 */
function sentinel_portal_queue_build_message_html($sample_entity, string $country, bool $is_pass, string $sample_type, bool $ucr_pending = FALSE): string {
  $company_name = sentinel_portal_queue_get_sample_value($sample_entity, 'company_name') ?? 'Customer';
  $company_name = Html::escape($company_name);
  $installer_name = sentinel_portal_queue_get_sample_value($sample_entity, 'installer_name') ?? $company_name;
  $installer_name = Html::escape($installer_name);

  // If UCR is pending, always use English message and send to admin.
  if ($ucr_pending) {
    return '<p>Dear Admin,</p>'
      . '<p>Please find attached a report on a recently submitted sample.</p>'
      . '<p><strong>Note:</strong> This sample was created with pending details. This sample is not linked to any user account, and the UCR (Unique Customer Reference) is also set to pending.</p>'
      . '<p>We need to sync this sample later when we have the correct details for it.</p>'
      . '<p>The attached report provides a report direct from the Sentinel Laboratory on the condition of the central heating water and the level of Sentinel X100 Inhibitor present in the sample submitted by an unknown user. It also provides a brief analysis of the mains water.</p>'
      . '<p>Based on the findings, Sentinel have provided recommendations to ensure the system water allows the central heating systems to operate at optimum efficiency with a minimum of scale and corrosion deposits.</p>'
      . '<p>Regards,</p>'
      . '<p>Sentinel Laboratory</p>';
  }

  // Normal email flow for non-pending UCR samples.
  switch ($country) {
    case 'it':
      return '<p>Gentile cliente,</p>'
        . "<p>Grazie per aver scelto il pacchetto di controllo dell'impianto Sentinel.</p>"
        . "<p>Il rapporto allegato fornisce un report diretto dal Laboratorio Sentinel sulle condizioni dell'acqua dell'impianto di riscaldamento centrale e sul livello di Inibitore Sentinel X100 presente nel campione da lei inviato. Fornisce anche una breve analisi dell'acqua della rete idrica.</p>"
        . '<p>Sulla base delle risultanze, Sentinel ha fornito raccomandazioni al fine di garantire che l&apos;acqua dell&apos;impianto consenta al sistema di riscaldamento centrale di funzionare a livelli ottimali di efficienza con un minimo di incrostazioni e depositi di corrosione.</p>'
        . '<p>Ulteriori informazioni sui prodotti Sentinel sono disponibili sul sito www.sentinelprotects.com.</p>'
        . '<p>Distinti saluti,</p>'
        . '<p>Sentinel Laboratory</p>';

    case 'de':
      return '<p>Sehr geehrter Kunde,</p>'
        . '<p>Vielen Dank, dass Sie sich für das Sentinel System Check Paket entschieden haben.</p>'
        . '<p>Der beigefügte Bericht direkt aus dem Sentinel Labor informiert Sie über den Zustand des Zentralheizungswassers und die Menge Sentinel X100 Inhibitor, die in der von Ihnen eingeschickten Probe vorhanden ist. Er bietet auch eine kurze Analyse des Speisewassers.</p>'
        . '<p>Aufgrund der Ergebnisse gibt Sentinel Empfehlungen, um sicherzustellen, dass die Zentralheizungssysteme mit optimaler Effizienz und einem Minimum an Kesselstein- und Korrosionsablagerungen betrieben werden können.</p>'
        . '<p>Weitere Informationen über Sentinel Produkte finden Sie auf unserer Website www.sentinelprotects.com.</p>'
        . '<p>Mit freundlichen Grüßen,</p>'
        . '<p>Sentinel Laboratory</p>';

    case 'fr':
      return '<p>Cher client,</p>'
        . '<p>Merci d&apos;avoir choisi le kit Sentinel System Check.</p>'
        . '<p>Le rapport ci-joint provenant directement du laboratoire Sentinel vous renseigne sur l&apos;état de l&apos;eau du chauffage central et le niveau d&apos;inhibiteur Sentinel X100 présent dans l&apos;échantillon que vous nous avez transmis. Il contient aussi une analyse succincte de l&apos;eau courante.</p>'
        . '<p>Sur la base des résultats, Sentinel fournit des recommandations afin d&apos;assurer que l&apos;eau du système permette au chauffage central de fonctionner à un niveau d&apos;efficacité optimal avec un minimum d&apos;incrustations et de dépôts de corrosion.</p>'
        . '<p>Vous pouvez obtenir davantage d&apos;informations sur les produits Sentinel sur www.sentinelprotects.com.</p>'
        . '<p>Cordialement,</p>'
        . '<p>Sentinel Laboratory</p>';
  }

  // Default to English messages with special handling for Vaillant packs.
  if ($sample_type === 'vaillant') {
    if ($is_pass) {
      return '<p>Dear ' . $company_name . ',</p>'
        . '<p>Please find attached a report on your recently submitted sample.</p>'
        . '<p>As you will see, it has been allocated a PASS designation and so no further action is needed.</p>'
        . '<p>Regards,</p>'
        . '<p>Sentinel Laboratory</p>';
    }

    $repeated = 0;
    if (function_exists('sentinel_portal_sample_repeated_failed_test')) {
      $repeated = sentinel_portal_sample_repeated_failed_test($sample_entity);
    }

    if ($repeated >= 2) {
      return '<p>Dear ' . $installer_name . ',</p>'
        . '<p>Please find attached a report on your recently submitted sample. This is the second time that a sample has been submitted from this particular system and it has again been allocated a FAIL designation. Additional action is necessary and a summary of our recommendations is given in the report. No further samples from this system can be analysed free of charge and you are requested to contact Vaillant for further instructions/training/advice.</p>'
        . '<p>For further testing of this system, you should purchase a standard Sentinel System Check from a merchant. Please DO NOT submit this with the paperwork supplied with the System Check but print off the attached form to accompany the samples. Also please note that the freepost address for these samples MUST be:</p>'
        . '<p>FREEPOST RSCS-SJHL-GHAU<br/>Scientifics Environmental Chemistry<br/>PO Box 100<br/>Bretby Business Park<br/>Burton-upon-Trent<br/>DE15 0XD</p>'
        . '<p>Please ensure that the existing freepost label is covered.</p>'
        . '<p>If further advice is required, please contact 01928 588330.</p>'
        . '<p>Regards,</p>'
        . '<p>Sentinel Laboratory</p>';
    }

    return '<p>Dear ' . $installer_name . ',</p>'
      . '<p>Please find attached a report on your recently submitted sample.</p>'
      . '<p>As you will see, it has been allocated a FAIL designation and additional action is necessary &ndash; a summary of our recommendations is given in the report.</p>'
      . '<p>If further advice is required, please contact 01928 588330.</p>'
      . '<p>Regards,</p>'
      . '<p>Sentinel Laboratory</p>';
  }

  // If UCR is pending, modify the email message.
  if ($ucr_pending) {
    return '<p>Dear ' . $installer_name . ',</p>'
      . '<p>Please find attached a report on your recently submitted sample.</p>'
      . '<p><strong>Note:</strong> This sample was processed with a pending UCR (Unique Customer Reference). Please ensure your UCR is correctly registered in your account settings to ensure proper tracking and future sample processing.</p>'
      . '<p>The attached report provides a report direct from the Sentinel Laboratory on the condition of the central heating water and the level of Sentinel X100 Inhibitor present in the sample you submitted. It also provides a brief analysis of the mains water.</p>'
      . '<p>Based on the findings, Sentinel have provided recommendations to ensure the system water allows the central heating systems to operate at optimum efficiency with a minimum of scale and corrosion deposits.</p>'
      . '<p>Further information on Sentinel products can be obtained through our website www.sentinelprotects.com.</p>'
      . '<p>If you have any questions regarding your UCR or account settings, please contact us.</p>'
      . '<p>Regards,</p>'
      . '<p>Sentinel Laboratory</p>';
  }

  return '<p>Dear Customer,</p>'
    . '<p>Thank you for choosing the Sentinel SystemCheck pack.</p>'
    . '<p>The attached report provides a report direct from the Sentinel Laboratory on the condition of the central heating water and the level of Sentinel X100 Inhibitor present in the sample you submitted. It also provides a brief analysis of the mains water.</p>'
    . '<p>Based on the findings, Sentinel have provided recommendations to ensure the system water allows the central heating systems to operate at optimum efficiency with a minimum of scale and corrosion deposits.</p>'
    . '<p>Further information on Sentinel products can be obtained through our website www.sentinelprotects.com.</p>'
    . '<p>Regards,</p>'
    . '<p>Sentinel Laboratory</p>';
}

/**
 * Send the email to the recipient list with the PDF attachment.
 */
function sentinel_portal_queue_send_email_with_attachment(array $email_payload, array $pdf_info): bool {
  $mailer = sentinel_portal_queue_get_mailer();

  $site_config = \Drupal::config('system.site');
  $from_address = $site_config->get('mail') ?: 'noreply@portal.sentinelprotects.com';
  $from_name = $site_config->get('name') ?: 'Sentinel';

  $email = new Email();
  $email->from(new Address($from_address, $from_name));

  // Respect SMTP reroute configuration if present (e.g. during testing).
  $reroute_address = '';
  if (\Drupal::hasContainer()) {
    try {
      $reroute_address = \Drupal::config('smtp.settings')->get('smtp_reroute_address') ?? '';
    }
    catch (\Exception $e) {
      $reroute_address = '';
    }
  }

  if (!empty($reroute_address)) {
    \Drupal::logger('sentinel_portal_queue')->info('Sendresults rerouted to @address.', ['@address' => $reroute_address]);
    $email->addTo($reroute_address);
  }
  else {
    \Drupal::logger('sentinel_portal_queue')->info('Sendresults recipients: @recipients', ['@recipients' => implode(', ', $email_payload['recipients'])]);
    foreach ($email_payload['recipients'] as $recipient) {
      $email->addTo($recipient);
    }
  }

  $email->subject($email_payload['subject']);
  $email->html($email_payload['message_html']);
  $email->text($email_payload['message_plain'] ?: MailFormatHelper::htmlToText($email_payload['message_html']));

  if (!empty($pdf_info['path']) && file_exists($pdf_info['path'])) {
    $filename = $pdf_info['filename'] ?? basename($pdf_info['path']);
    $email->attachFromPath($pdf_info['path'], $filename, 'application/pdf');
  }

  try {
    $mailer->send($email);
    \Drupal::logger('sentinel_portal_queue')->info('Sendresults email dispatched with subject @subject.', ['@subject' => $email_payload['subject']]);
    return TRUE;
  }
  catch (\Exception $e) {
    \Drupal::logger('sentinel_portal_queue')->error('Failed to send sample certificate email: @message', ['@message' => $e->getMessage()]);
    return FALSE;
  }
}

/**
 * Get a configured Symfony mailer instance.
 */
function sentinel_portal_queue_get_mailer(): MailerInterface {
  static $mailer;

  if ($mailer instanceof MailerInterface) {
    return $mailer;
  }

  $transport = NULL;

  try {
    if (\Drupal::moduleHandler()->moduleExists('smtp')) {
      $smtp_config = \Drupal::config('smtp.settings');
      $host = $smtp_config->get('smtp_host');
      if (!empty($host)) {
        $user = $smtp_config->get('smtp_username') ?: NULL;
        $password = $smtp_config->get('smtp_password') ?: NULL;
        $port = $smtp_config->get('smtp_port');
        $port = $port ? (int) $port : NULL;
        $protocol = strtolower($smtp_config->get('smtp_protocol') ?? '');

        $params = [];
        $transport_name = 'smtp';
        if ($protocol === 'ssl') {
          $transport_name = 'smtps';
        }
        elseif ($protocol === 'tls') {
          $params['encryption'] = 'tls';
        }

        if (!empty($user)) {
          $params['auth_mode'] = 'login';
        }

        $dsn = new Dsn(
          $transport_name,
          $host,
          $user,
          $password,
          $port,
          $params
        );

        $transport_factory = new Transport(Transport::getDefaultFactories());
        $transport = $transport_factory->fromDsnObject($dsn);
      }
    }

    if (!$transport) {
      $config = \Drupal::config('system.mail')->get('mailer_dsn') ?? [];
      if (!empty($config['scheme'])) {
        $dsn = new Dsn(
          $config['scheme'],
          $config['host'] ?? 'default',
          $config['user'] ?? '',
          $config['password'] ?? '',
          isset($config['port']) && $config['port'] !== NULL ? (int) $config['port'] : NULL,
          $config['options'] ?? []
        );
        $transport_factory = new Transport(Transport::getDefaultFactories());
        $transport = $transport_factory->fromDsnObject($dsn);
      }
      else {
        $transport = Transport::fromDsn('sendmail://default');
      }
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('sentinel_portal_queue')->error('Mailer initialisation failure: @message', ['@message' => $e->getMessage()]);
    $transport = Transport::fromDsn('sendmail://default');
  }
  
  $mailer = new Mailer($transport);
  return $mailer;
}

/**
 * Implements hook_views_data().
 */
function sentinel_portal_queue_views_data() {
  $data = [];

  $data['sentinel_portal_queue'] = [
    'table' => [
      'group' => t('Sentinel queue'),
      'base' => [
        'field' => 'item_id', // This is the identifier field for the view.
        'title' => t('Sentinel queue id'),
        'help' => t('Sentinel queue id'),
        'weight' => -10,
      ],
      'join' => [
        'sentinel_sample' => [
          'left_field' => 'pid',
          'field' => 'pid',
        ],
      ],
    ],
    'pid' => [
      'title' => t('Sentinel pack id in the queue'),
      'help' => t('Sentinel pack id in the queue'),
      'field' => [
        'id' => 'numeric',
        'click sortable' => TRUE,
      ],
      'sort' => [
        'id' => 'standard',
      ],
      'filter' => [
        'id' => 'numeric',
      ],
    ],
    'action' => [
      'title' => t('The reason for the pack being in the queue'),
      'help' => t('The reason for the pack being in the queue'),
      'field' => [
        'id' => 'standard',
        'click sortable' => TRUE,
      ],
      'sort' => [
        'id' => 'standard',
      ],
      'filter' => [
        'id' => 'string',
      ],
    ],
  ];

  return $data;
}

