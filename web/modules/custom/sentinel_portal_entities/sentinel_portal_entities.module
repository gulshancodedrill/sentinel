<?php

use Drupal\Core\Database\Connection;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\EntityTypeManagerInterface;
use Drupal\Core\Link;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Url;
use Drupal\user\UserInterface;
use Drupal\views\Plugin\views\query\QueryPluginBase;
use Drupal\views\Plugin\views\query\Sql;
use Drupal\views\ViewExecutable;
use Drupal\sentinel_portal_entities\Entity\SentinelClient;
use Drupal\sentinel_portal_entities\Entity\SentinelSample;
use Drupal\Component\Render\MarkupInterface;

/**
 * @file
 * Hooks and callbacks for the Sentinel Portal Entities module.
 */

/**
 * Implements hook_views_query_alter().
 */
function sentinel_portal_entities_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  if ($view->id() !== 'sentinel_sample' || !$query instanceof Sql) {
    return;
  }

  // Ensure the Sentinel client table is joined for filtering.
  $join_definition = [
    'type' => 'LEFT',
    'table' => 'sentinel_client',
    'field' => 'ucr',
    'left_table' => 'sentinel_sample',
    'left_field' => 'ucr',
  ];

  /** @var \Drupal\views\Plugin\views\join\JoinPluginBase $join */
  $join = \Drupal::service('plugin.manager.views.join')->createInstance('standard', $join_definition);
  $client_alias = $query->ensureTable('sentinel_client', NULL, $join);

  if (!$client_alias) {
    return;
  }

  $current_user = \Drupal::currentUser();

  // Restrict results to the logged-in user's client unless they have admin access.
  if ($current_user->isAuthenticated() && !$current_user->hasPermission('administer sentinel_sample')) {
    $uid = (int) $current_user->id();
    if ($uid > 0) {
      $query->addWhere(0, "$client_alias.uid", $uid, '=');
    }
  }
}

/**
 * Helper to retrieve the entity type manager service.
 *
 * @return \Drupal\Core\Entity\EntityTypeManagerInterface
 *   The entity type manager service.
 */
function _sentinel_portal_entities_entity_type_manager(): EntityTypeManagerInterface {
  return \Drupal::entityTypeManager();
}

/**
 * Helper to retrieve the database connection service.
 *
 * @return \Drupal\Core\Database\Connection
 *   The database connection service.
 */
function _sentinel_portal_entities_database(): Connection {
  return \Drupal::database();
}

/**
 * Create a notice for a user.
 *
 * @param \Drupal\Core\Session\AccountInterface|\Drupal\user\UserInterface $user
 *   The user that should receive the notice.
 * @param string $title
 *   Notice title.
 * @param string $message
 *   Notice message.
 *
 * @return \Drupal\sentinel_portal_entities\Entity\SentinelNotice|false
 *   The created notice entity or FALSE on failure.
 */
function _sentinel_portal_entities_create_notice($user, string $title, string $message) {
  if ($user instanceof AccountInterface && !($user instanceof UserInterface)) {
    $user = \Drupal::entityTypeManager()->getStorage('user')->load($user->id());
  }

  if (!$user instanceof UserInterface) {
    return FALSE;
  }

  $storage = _sentinel_portal_entities_entity_type_manager()->getStorage('sentinel_notice');

  $values = [
    'uid' => $user->id(),
    'title' => $title,
    'notice' => $message,
    'notice_read' => FALSE,
    'created' => \Drupal::time()->getRequestTime(),
  ];

  /** @var \Drupal\sentinel_portal_entities\Entity\SentinelNotice $entity */
  $entity = $storage->create($values);
  $entity->save();

  return $entity;
}

/**
 * Load a sentinel client entity by Drupal user.
 *
 * @param \Drupal\Core\Session\AccountInterface|\Drupal\user\UserInterface|int|null $account
 *   The user, user ID, or NULL for current user.
 *
 * @return \Drupal\sentinel_portal_entities\Entity\SentinelClient|false
 *   Sentinel client entity or FALSE if none found.
 */
function sentinel_portal_entities_get_client_by_user($account = NULL) {
  if ($account === NULL) {
    $account = \Drupal::currentUser();
  }

  if (is_numeric($account)) {
    $uid = (int) $account;
    $user = \Drupal::entityTypeManager()->getStorage('user')->load($uid);
  }
  elseif ($account instanceof AccountInterface && !($account instanceof UserInterface)) {
    $uid = (int) $account->id();
    $user = \Drupal::entityTypeManager()->getStorage('user')->load($uid);
  }
  elseif ($account instanceof UserInterface) {
    $uid = (int) $account->id();
    $user = $account;
  }
  else {
    return FALSE;
  }

  if (!$uid || !$user instanceof UserInterface) {
    return FALSE;
  }

  static $cache = [];
  if (isset($cache[$uid])) {
    return $cache[$uid];
  }

  $storage = _sentinel_portal_entities_entity_type_manager()->getStorage('sentinel_client');

  $ids = \Drupal::entityQuery('sentinel_client')
    ->condition('uid', $uid)
    ->range(0, 1)
    ->accessCheck(FALSE)
    ->execute();

  if (!$ids && $user->getEmail()) {
    $ids = \Drupal::entityQuery('sentinel_client')
      ->condition('email', $user->getEmail(), '=')
      ->range(0, 1)
      ->accessCheck(FALSE)
      ->execute();
  }

  if (!$ids) {
    $cache[$uid] = FALSE;
    return FALSE;
  }

  $client = $storage->load(reset($ids));
  $cache[$uid] = $client ?: FALSE;

  return $cache[$uid];
}

/**
 * Ensure a sentinel client exists for a user and keep it in sync.
 *
 * @param \Drupal\user\UserInterface $user
 *   The user being synchronised.
 *
 * @return \Drupal\sentinel_portal_entities\Entity\SentinelClient|null
 *   The sentinel client entity or NULL on failure.
 */
function sentinel_portal_entities_sync_client_from_user(UserInterface $user): ?SentinelClient {
  $storage = _sentinel_portal_entities_entity_type_manager()->getStorage('sentinel_client');

  /** @var \Drupal\sentinel_portal_entities\Entity\SentinelClient|null $client */
  $client = sentinel_portal_entities_get_client_by_user($user);

  if (!$client) {
    $values = [
      'uid' => $user->id(),
      'name' => $user->getDisplayName(),
      'email' => $user->getEmail(),
      'api_key' => '',
      'send_pending' => FALSE,
    ];

    /** @var \Drupal\sentinel_portal_entities\Entity\SentinelClient $client */
    $client = $storage->create($values);
    $client->save();
  }
  else {
    $needs_save = FALSE;

    if ($client->get('uid')->value !== $user->id()) {
      $client->set('uid', $user->id());
      $needs_save = TRUE;
    }

    $client_name = $client->get('name')->value ?? '';
    $user_name = $user->getDisplayName();
    if ($client_name !== $user_name) {
      $client->set('name', $user_name);
      $needs_save = TRUE;
    }

    $client_email = $client->get('email')->value ?? '';
    $user_email = $user->getEmail();
    if ($user_email && $client_email !== $user_email) {
      $client->set('email', $user_email);
      $needs_save = TRUE;
    }

    if ($needs_save) {
      $client->save();
    }
  }

  if ($client instanceof SentinelClient && method_exists($client, 'ensureRealUcr')) {
    $client->ensureRealUcr();
  }

  return $client;
}

/**
 * Implements hook_entity_insert().
 */
function sentinel_portal_entities_entity_insert(EntityInterface $entity) {
  if ($entity instanceof UserInterface) {
    sentinel_portal_entities_sync_client_from_user($entity);
  }
}

/**
 * Implements hook_entity_update().
 */
function sentinel_portal_entities_entity_update(EntityInterface $entity) {
  if ($entity instanceof UserInterface) {
    sentinel_portal_entities_sync_client_from_user($entity);
  }
}

/**
 * Load a sentinel client by UCR number.
 *
 * @param int $ucr
 *   The UCR identifier.
 *
 * @return \Drupal\sentinel_portal_entities\Entity\SentinelClient|false
 *   Sentinel client entity or FALSE if not found.
 */
function sentinel_portal_entities_get_client_by_ucr($ucr) {
  if (empty($ucr)) {
    return FALSE;
  }

  $ids = \Drupal::entityQuery('sentinel_client')
    ->condition('ucr', $ucr)
    ->range(0, 1)
    ->accessCheck(FALSE)
    ->execute();

  if (!$ids) {
    return FALSE;
  }

  return _sentinel_portal_entities_entity_type_manager()->getStorage('sentinel_client')->load(reset($ids));
}

/**
 * Retrieve sentinel sample field metadata keyed by machine name.
 *
 * @return array
 *   Associative array of field definitions matching the legacy schema data.
 */
function sentinel_portal_entities_get_sample_fields(): array {
  $fields = &drupal_static(__FUNCTION__);
  if (!isset($fields)) {
    $fields = [];
    $definitions = \Drupal::service('entity_field.manager')->getFieldDefinitions('sentinel_sample', 'sentinel_sample');
    $weight = 0;

    foreach ($definitions as $field_name => $definition) {
      $portal_config = $definition->getSetting('portal_config');
      if (!is_array($portal_config)) {
        $portal_config = [];
      }

      if (empty($portal_config['title'])) {
        $label = $definition->getLabel();
        if (is_object($label)) {
          $label = (string) $label;
        }
        $portal_config['title'] = $label ?: ucwords(str_replace('_', ' ', $field_name));
      }

      if (!isset($portal_config['weight'])) {
        $portal_config['weight'] = $weight;
      }

      $fields[$field_name] = [
        'type' => $definition->getType(),
        'settings' => $definition->getSettings(),
        'portal_config' => $portal_config,
      ];

      $weight++;
    }
  }

  return $fields;
}

/**
 * Render callback for system location fields â€“ link to the address entity.
 *
 * @param string|null $value
 *   The existing field value.
 * @param \Drupal\sentinel_portal_entities\Entity\SentinelSample|null $sample
 *   The sentinel sample entity.
 *
 * @return \Drupal\Core\Link|string
 *   A link renderable or the original value when linking is not possible.
 */
function sentinel_portal_entities_link_address($value, SentinelSample $sample = NULL) {
  if ($sample === NULL || $value === NULL || $value === '') {
    return $value ?? '';
  }

  if (!$sample->hasField('sentinel_sample_address_target_id') || $sample->get('sentinel_sample_address_target_id')->isEmpty()) {
    return $value;
  }

  $target = $sample->get('sentinel_sample_address_target_id')->value;
  if (empty($target)) {
    return $value;
  }

  $url = Url::fromUri('internal:/address/address/' . $target);
  return Link::fromTextAndUrl($value, $url);
}

/**
 * Value callback to render pass / fail labels.
 *
 * @param string|int|null $value
 *   The stored value.
 * @param \Drupal\sentinel_portal_entities\Entity\SentinelSample|null $sample
 *   The sentinel sample entity.
 *
 * @return string|null
 *   Human readable pass/fail output.
 */
function sentinel_portal_entities_print_pass_fail($value, SentinelSample $sample = NULL) {
  if ($value === NULL || $value === '') {
    return NULL;
  }

  return ((int) $value === 1) ? t('Pass') : t('Fail');
}

/**
 * Value callback for nitrate results.
 *
 * @param string|int|null $value
 *   The stored value.
 * @param \Drupal\sentinel_portal_entities\Entity\SentinelSample|null $sample
 *   The sentinel sample entity.
 *
 * @return string|null
 *   Display string for nitrate results.
 */
function sentinel_portal_entities_nitrate_result($value, SentinelSample $sample = NULL) {
  if ($value === NULL || $value === '') {
    return NULL;
  }

  return ((int) $value === 0) ? '< 100' : '> 100';
}

/**
 * Validate a pack reference number.
 */
function valid_pack_reference_number($packref): bool {
  $pattern = '/^([0-9]{3})[:\s-]?([0-9]{3,10}[a-zA-Z]?)$/';
  $packref = trim((string) $packref);
  if (!preg_match($pattern, $packref)) {
    return FALSE;
  }

  return strpos($packref, ':') === 3;
}

/**
 * Normalise a pack reference number to NNN:XXXX format.
 */
function sentinel_portal_entities_format_packref($packref) {
  $pattern = '/^([0-9]{3})[:\s-]?([0-9]{3,10}[a-zA-Z]?)$/';
  $matches = [];
  preg_match($pattern, trim((string) $packref), $matches);
  if (!empty($matches[1]) && !empty($matches[2])) {
    return $matches[1] . ':' . $matches[2];
  }
  return FALSE;
}

/**
 * Load a sentinel sample by pack reference number.
 */
function sentinel_portal_entities_get_sample_by_reference_number($pack_reference_number, $ucr = FALSE) {
  if (empty($pack_reference_number)) {
    return FALSE;
  }

  $query = \Drupal::entityQuery('sentinel_sample')
    ->condition('pack_reference_number', $pack_reference_number)
    ->range(0, 1)
    ->accessCheck(FALSE);

  if ($ucr !== FALSE) {
    $query->condition('ucr', $ucr);
  }

  $ids = $query->execute();

  if (!$ids) {
    return FALSE;
  }

  return _sentinel_portal_entities_entity_type_manager()->getStorage('sentinel_sample')->load(reset($ids));
}

/**
 * Create a sentinel sample entity from raw data.
 */
function sentinel_portal_entities_create_sample(array $data) {
  $storage = _sentinel_portal_entities_entity_type_manager()->getStorage('sentinel_sample');
  $filtered = array_filter($data, static function ($value) {
    return !($value === '' || $value === NULL);
  });

  /** @var \Drupal\sentinel_portal_entities\Entity\SentinelSample $entity */
  $entity = $storage->create($filtered);
  $entity->save();

  return $entity;
}

/**
 * Update an existing sentinel sample entity with raw data.
 */
function sentinel_portal_entities_update_sample($sample, array $data) {
  if (is_numeric($sample)) {
    $sample = _sentinel_portal_entities_entity_type_manager()->getStorage('sentinel_sample')->load($sample);
  }

  if (!$sample) {
    return FALSE;
  }

  foreach ($data as $field => $value) {
    if ($sample->hasField($field)) {
      if ($value === NULL || $value === '') {
        $sample->set($field, NULL);
      }
      else {
        $sample->set($field, $value);
      }
    }
  }

  // Create a new revision on each update.
  $sample->setNewRevision(TRUE);
  $sample->save();
  return $sample;
}

function sentinel_portal_entities_render_field_value($value) {
  if ($value instanceof Link) {
    return ['data' => $value];
  }

  if ($value instanceof MarkupInterface) {
    return ['data' => ['#markup' => $value->__toString(), '#allowed_tags' => ['a', 'span']]];
  }

  if (is_array($value) && isset($value['#type'])) {
    return ['data' => $value];
  }

  if (is_array($value)) {
    $value = implode(', ', array_filter(array_map('strval', $value), static function ($item) {
      return $item !== '';
    }));
  }

  if ($value === NULL || $value === '') {
    return ['data' => ['#markup' => '&nbsp;']];
  }

  return ['data' => ['#plain_text' => (string) $value]];
}


/**
* Implements hook_views_data_alter().
*/
function sentinel_portal_entities_views_data_alter(array &$data) {
  if (isset($data['sentinel_sample']['fileid']['field'])) {
    $data['sentinel_sample']['fileid']['field']['id'] = 'sentinel_sample_pdf_link';
    $data['sentinel_sample']['fileid']['field']['title'] = t('Download PDF');
    $data['sentinel_sample']['fileid']['field']['help'] = t('Displays a PDF download link based on the File ID.');
  }
 
  foreach (['date_booked', 'date_reported'] as $date_field) {
    if (isset($data['sentinel_sample'][$date_field]['field'])) {
      $data['sentinel_sample'][$date_field]['field']['id'] = 'sentinel_sample_legacy_date';
      $data['sentinel_sample'][$date_field]['field']['title'] = t('Formatted date');
      $data['sentinel_sample'][$date_field]['field']['help'] = t('Displays legacy Sentinel Sample dates even if they are formatted with spaces instead of ISO timestamps.');
    }
  }
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function sentinel_portal_entities_menu_local_tasks_alter(&$data, $route_name) {
  // Remove tabs from revision overview page.
  if ($route_name === 'entity.sentinel_sample.version_history') {
    $data['tabs'][0] = [];
  }
}

/**
 * Implements hook_preprocess_block().
 */
function sentinel_portal_entities_preprocess_block(&$variables) {
  // Remove "-FINAL" from page title block for sentinel_sample routes.
  if (isset($variables['elements']['#plugin_id']) && $variables['elements']['#plugin_id'] === 'page_title_block') {
    $route_name = \Drupal::routeMatch()->getRouteName();
    if (in_array($route_name, ['entity.sentinel_sample.version_history', 'entity.sentinel_sample.revision_compare'])) {
      if (isset($variables['content']['#title'])) {
        $title = $variables['content']['#title'];
        if (is_string($title)) {
          $title = preg_replace('/-FINAL$/i', '', $title);
          $variables['content']['#title'] = $title;
        }
        elseif (is_array($title) && isset($title['#markup'])) {
          $title['#markup'] = preg_replace('/-FINAL$/i', '', $title['#markup']);
          $variables['content']['#title'] = $title;
        }
      }
      // Also check in content array directly.
      if (isset($variables['content'][0]['#markup'])) {
        $variables['content'][0]['#markup'] = preg_replace('/-FINAL$/i', '', $variables['content'][0]['#markup']);
      }
    }
  }
}

/**
 * Implements hook_requirements_alter().
 * 
 * Suppresses entity/field definition mismatch warnings from the status report.
 * This prevents Drupal from flagging entity types as needing updates even if
 * the database schema differs from the entity type definitions.
 */
function sentinel_portal_entities_requirements_alter(array &$requirements): void {
  // Remove the entity_update requirement to suppress entity definition warnings.
  // This prevents the status report from showing "Mismatched entity and/or field definitions"
  // even if getChangeList() detects differences between database schema and definitions.
  if (isset($requirements['entity_update'])) {
    unset($requirements['entity_update']);
  }
}
